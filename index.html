<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Governor Stats Viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body { font-family: Arial, sans-serif; background:#f4f6f9; padding:20px; margin:0; }
    h1 { color:#333; margin-bottom:6px; }
    .container { background:#fff; padding:20px; border-radius:12px; max-width:900px; margin:auto; box-shadow:0 0 10px rgba(0,0,0,.08); }
    .last-updated { color:#555; margin-bottom:14px; font-size:14px; }
    .data-table { width:100%; border-collapse:collapse; margin-top:14px; }
    .data-table th, .data-table td { text-align:left; padding:8px 12px; border-bottom:1px solid #e5e7eb; }
    .data-table th { background:#f0f2f5; width:260px; }
    .footer { margin-top:22px; text-align:center; color:#888; font-size:13px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Governor Stats Viewer</h1>
    <div id="last-updated" class="last-updated">Last updated: …</div>
    <p>Searching for Governor ID: <strong>135559879</strong></p>
    <div id="output">Loading…</div>
  </div>
  <div class="footer">Data provided by prokingdoms.com</div>

  <script>
    const GOV_ID = "135559879";
    const API_URL = "https://beta.prokingdoms.com/proxy-fast/stats/kvk/5854";

    // --- time helpers (force UTC) ---
    function parseServerUTC(t) {
      if (!t) return null;
      if (typeof t !== "string") return new Date(t);
      if (t.includes("Z") || /[+\-]\d{2}:\d{2}$/.test(t)) return new Date(t);
      return new Date(t.replace(" ", "T") + "Z");
    }
    function fmtUTC(t) {
      const d = parseServerUTC(t);
      if (!d || isNaN(d)) return "—";
      return (
        d.getUTCFullYear() + "-" +
        String(d.getUTCMonth() + 1).padStart(2,"0") + "-" +
        String(d.getUTCDate()).padStart(2,"0") + " " +
        String(d.getUTCHours()).padStart(2,"0") + ":" +
        String(d.getUTCMinutes()).padStart(2,"0") + ":" +
        String(d.getUTCSeconds()).padStart(2,"0") + "." +
        String(d.getUTCMilliseconds()).padStart(3,"0") + " UTC"
      );
    }
    function timeAgoUTC(t) {
      const d = parseServerUTC(t);
      if (!d || isNaN(d)) return "";
      const diffMs = Date.now() - d.getTime();
      if (diffMs < 60000) return "just now";
      const mins = Math.floor(diffMs/60000);
      if (mins < 60) return mins + " minutes ago";
      const hrs = Math.floor(mins/60);
      if (hrs < 24) return hrs + " hours ago";
      const days = Math.floor(hrs/24);
      return days + " days ago";
    }
    const fmtNum = n => (n==null || isNaN(n)) ? "—" : Number(n).toLocaleString();

    async function fetchGovernorStats() {
      try {
        // always cache-bust silently
        const url = `${API_URL}?_=${Date.now()}`;
        const response = await fetch(url, {
          method: "POST",
          cache: "no-store",
          headers: {
            "Content-Type": "application/json",
            "Cache-Control": "no-cache",
            "Pragma": "no-cache"
          },
          body: JSON.stringify({
            searchString: GOV_ID,
            pageNumber: 1,
            isFullTable: false,
            isLiveTable: true
          })
        });

        // handle non-JSON/null safely
        let data = null;
        try { data = await response.json(); } catch { data = null; }

        const governor = data?.kvkDetailsData?.[0];
        if (!governor) {
          document.getElementById("output").textContent = "No data found.";
          document.getElementById("last-updated").textContent = "Last updated: —";
          return;
        }

        const serverLast = governor.last_update || data?.last_update;
        document.getElementById("last-updated").textContent =
          `Last updated: ${fmtUTC(serverLast)} today (${timeAgoUTC(serverLast)})`;

        const camps = data?.campsList || [];
        const camp = (camps.find(c => c.id === governor.campid)?.iconName) || "Unknown";

        const output = `
          <table class="data-table">
            <tr><th>Rank</th><td>${fmtNum(governor.rank)}</td></tr>
            <tr><th>Name</th><td>${governor.name} (the best player in the game)</td></tr>
            <tr><th>Governor ID</th><td>${governor.governor_id}</td></tr>
            <tr><th>Kingdom</th><td>${governor.kingdom}</td></tr>
            <tr><th>Camp</th><td>${camp}</td></tr>
            <tr><th>Min Points</th><td>${fmtNum(governor.min_points)}</td></tr>
            <tr><th>Max Points</th><td>${fmtNum(governor.max_points)}</td></tr>
            <tr><th>KP gain (Max - Min)</th><td style="color:red;">${fmtNum(governor.points_difference)}</td></tr>
            <tr><th>Min Power</th><td>${fmtNum(governor.min_power)}</td></tr>
            <tr><th>Max Power</th><td>${fmtNum(governor.max_power)}</td></tr>
            <tr><th>Power Difference</th><td>${fmtNum(governor.power_difference)}</td></tr>
            <tr><th>First Update (Server)</th><td>${fmtUTC(governor.first_update)}</td></tr>
            <tr><th>Last Update (Server)</th><td>${fmtUTC(serverLast)}</td></tr>
            <tr><th>Scan Time (Client UTC)</th><td>${fmtUTC(new Date().toISOString())}</td></tr>
            <tr><th>Is Premium</th><td>${governor.is_premium ? "Yes" : "No"}</td></tr>
            <tr><th>KVK Name</th><td>${data?.kvkName || "—"}</td></tr>
            <tr><th>KVK Story</th><td>${data?.kvkStory || "—"}</td></tr>
          </table>
        `;
        document.getElementById("output").innerHTML = output;
      } catch (err) {
        document.getElementById("output").textContent = "Failed to load data.";
        document.getElementById("last-updated").textContent = "Last updated: —";
        console.error(err);
      }
    }

    fetchGovernorStats();
  </script>
</body>
</html>
